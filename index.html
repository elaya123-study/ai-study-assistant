<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Assistant</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons as SVG components
        const Upload = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,5 17,10"/>
                <line x1="12" y1="5" x2="12" y2="15"/>
            </svg>
        );

        const FileText = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14,2 L6,2 C4.9,2 4,2.9 4,4 L4,20 C4,21.1 4.9,22 6,22 L18,22 C19.1,22 20,21.1 20,20 L20,8 L14,2 Z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10,9 9,9 8,9"/>
            </svg>
        );

        const Brain = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 2a3 3 0 0 0-3 3 3 3 0 0 0-3 3v1a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0 3-3 3 3 0 0 0 3-3 3 3 0 0 0-3-3V8a3 3 0 0 0-3-3 3 3 0 0 0-3-3z"/>
            </svg>
        );

        const BarChart3 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 3v18h18"/>
                <path d="M18 17V9"/>
                <path d="M13 17V5"/>
                <path d="M8 17v-3"/>
            </svg>
        );

        const BookOpen = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
        );

        const Edit2 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        );

        const Trash2 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3,6 5,6 21,6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );

        const RefreshCw = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="23,4 23,10 17,10"/>
                <polyline points="1,20 1,14 7,14"/>
                <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
            </svg>
        );

        const Calendar = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
        );

        const Star = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
            </svg>
        );

        const CheckCircle = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22,4 12,14.01 9,11.01"/>
            </svg>
        );

        const Eye = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );

        const EyeOff = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
        );

        const AIStudyApp = () => {
            const [files, setFiles] = useState([]);
            const [subjects, setSubjects] = useState([]);
            const [flashcards, setFlashcards] = useState([]);
            const [conceptMaps, setConceptMaps] = useState([]);
            const [clozeCards, setClozeCards] = useState([]);
            const [practiceQuestions, setPracticeQuestions] = useState([]);
            const [currentView, setCurrentView] = useState('upload');
            const [selectedSubject, setSelectedSubject] = useState('all');
            const [currentItem, setCurrentItem] = useState(null);
            const [showAnswer, setShowAnswer] = useState(false);
            const [studyProgress, setStudyProgress] = useState({});
            const [isProcessing, setIsProcessing] = useState(false);

            // Initialize data from localStorage
            useEffect(() => {
                const saved = JSON.parse(localStorage.getItem('studyProgress') || '{}');
                setStudyProgress(saved);
                
                const savedFiles = JSON.parse(localStorage.getItem('aiStudyApp_files') || '[]');
                const savedSubjects = JSON.parse(localStorage.getItem('aiStudyApp_subjects') || '[]');
                const savedFlashcards = JSON.parse(localStorage.getItem('aiStudyApp_flashcards') || '[]');
                const savedClozeCards = JSON.parse(localStorage.getItem('aiStudyApp_clozeCards') || '[]');
                const savedConceptMaps = JSON.parse(localStorage.getItem('aiStudyApp_conceptMaps') || '[]');
                const savedPracticeQuestions = JSON.parse(localStorage.getItem('aiStudyApp_practiceQuestions') || '[]');
                
                setFiles(savedFiles);
                setSubjects(savedSubjects);
                setFlashcards(savedFlashcards);
                setClozeCards(savedClozeCards);
                setConceptMaps(savedConceptMaps);
                setPracticeQuestions(savedPracticeQuestions);
            }, []);

            // Save data to localStorage
            useEffect(() => {
                localStorage.setItem('studyProgress', JSON.stringify(studyProgress));
            }, [studyProgress]);

            useEffect(() => {
                localStorage.setItem('aiStudyApp_files', JSON.stringify(files));
            }, [files]);

            useEffect(() => {
                localStorage.setItem('aiStudyApp_subjects', JSON.stringify(subjects));
            }, [subjects]);

            useEffect(() => {
                localStorage.setItem('aiStudyApp_flashcards', JSON.stringify(flashcards));
            }, [flashcards]);

            useEffect(() => {
                localStorage.setItem('aiStudyApp_clozeCards', JSON.stringify(clozeCards));
            }, [clozeCards]);

            useEffect(() => {
                localStorage.setItem('aiStudyApp_conceptMaps', JSON.stringify(conceptMaps));
            }, [conceptMaps]);

            useEffect(() => {
                localStorage.setItem('aiStudyApp_practiceQuestions', JSON.stringify(practiceQuestions));
            }, [practiceQuestions]);

            const handleFileUpload = async (event) => {
                const uploadedFiles = Array.from(event.target.files);
                setIsProcessing(true);

                try {
                    for (const file of uploadedFiles) {
                        let content = '';
                        
                        if (file.type === 'text/markdown' || file.name.endsWith('.md')) {
                            content = await file.text();
                        } else {
                            content = `[File: ${file.name}] - Content extraction would be implemented with proper APIs`;
                        }

                        const newFile = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            type: file.type,
                            content: content,
                            uploadDate: new Date().toISOString(),
                            lastModified: file.lastModified
                        };

                        setFiles(prev => [...prev, newFile]);
                        await processFileWithAI(newFile);
                    }
                } catch (error) {
                    console.error('Error processing files:', error);
                } finally {
                    setIsProcessing(false);
                }
            };

            const processFileWithAI = async (file) => {
                try {
                    const highlights = extractHighlights(file.content);
                    const detectedSubject = detectSubjectFallback(file.content);
                    
                    setSubjects(prev => {
                        const existingSubject = prev.find(s => s.name === detectedSubject);
                        if (!existingSubject) {
                            return [...prev, { 
                                id: Date.now() + Math.random(), 
                                name: detectedSubject, 
                                isManual: false,
                                fileCount: 1 
                            }];
                        } else {
                            return prev.map(s => 
                                s.name === detectedSubject 
                                    ? { ...s, fileCount: (s.fileCount || 0) + 1 }
                                    : s
                            );
                        }
                    });

                    // 使用後備方案生成學習材料
                    const materials = generateFallbackMaterials(file.content, highlights, detectedSubject);
                    
                    if (materials.flashcards && materials.flashcards.length > 0) {
                        setFlashcards(prev => [...prev, ...materials.flashcards]);
                    }

                    if (materials.clozeCards && materials.clozeCards.length > 0) {
                        setClozeCards(prev => [...prev, ...materials.clozeCards]);
                    }
                    
                    if (materials.conceptMaps && materials.conceptMaps.length > 0) {
                        setConceptMaps(prev => [...prev, ...materials.conceptMaps]);
                    }
                    
                    if (materials.practiceQuestions && materials.practiceQuestions.length > 0) {
                        setPracticeQuestions(prev => [...prev, ...materials.practiceQuestions]);
                    }

                } catch (error) {
                    console.error('Error processing file:', error);
                    alert(`處理檔案時發生錯誤: ${error.message}`);
                }
            };

            const extractHighlights = (content) => {
                const highlights = [];
                
                const highlightMatches = content.match(/==(.*?)==/g) || [];
                highlights.push(...highlightMatches.map(match => match.replace(/==/g, '')));
                
                const boldMatches = content.match(/\*\*(.*?)\*\*/g) || [];
                highlights.push(...boldMatches.map(match => match.replace(/\*\*/g, '')));
                
                const italicMatches = content.match(/\*(.*?)\*/g) || [];
                highlights.push(...italicMatches.map(match => match.replace(/\*/g, '')));
                
                return [...new Set(highlights)];
            };

            const detectSubjectFallback = (content) => {
                const keywords = {
                    '數學': ['數學', '方程', '函數', '微積分', '代數', '幾何'],
                    '物理學': ['物理', '力學', '電磁', '熱力學', '量子'],
                    '化學': ['化學', '分子', '原子', '化合物', '反應'],
                    '生物學': ['生物', '細胞', '基因', 'DNA', '蛋白質'],
                    '歷史': ['歷史', '朝代', '戰爭', '革命', '古代'],
                    '英語': ['English', 'grammar', 'vocabulary', '英文', '語法']
                };
                
                for (const [subject, words] of Object.entries(keywords)) {
                    if (words.some(word => content.includes(word))) {
                        return subject;
                    }
                }
                return '一般';
            };

            const generateFallbackMaterials = (content, highlights, subject) => {
                const timestamp = Date.now();
                const sentences = content.split(/[。！？\n]/).filter(s => s.trim().length > 5);
                const materials = {
                    flashcards: [],
                    clozeCards: [],
                    conceptMaps: [],
                    practiceQuestions: []
                };
                
                // 生成閃卡
                highlights.slice(0, 5).forEach((highlight, index) => {
                    if (highlight.trim()) {
                        materials.flashcards.push({
                            id: `fc_${timestamp}_${index}`,
                            front: `什麼是${highlight}？`,
                            back: `${highlight}是一個重要概念，需要進一步學習和理解。`,
                            subject: subject,
                            difficulty: 'medium',
                            tags: [subject, '重點'],
                            created: new Date().toISOString(),
                            nextReview: new Date().toISOString(),
                            interval: 1,
                            easeFactor: 2.5,
                            reviewCount: 0
                        });
                    }
                });
                
                // 生成克漏字卡
                highlights.slice(0, 3).forEach((highlight, index) => {
                    const relatedSentence = sentences.find(s => s.includes(highlight));
                    if (relatedSentence) {
                        materials.clozeCards.push({
                            id: `cz_${timestamp}_${index}`,
                            text: relatedSentence.replace(highlight, `{{c1::${highlight}}}`),
                            subject: subject,
                            difficulty: 'medium',
                            tags: [subject, '填空'],
                            created: new Date().toISOString(),
                            nextReview: new Date().toISOString(),
                            interval: 1,
                            easeFactor: 2.5,
                            reviewCount: 0
                        });
                    }
                });
                
                // 生成概念圖
                if (highlights.length > 0) {
                    materials.conceptMaps.push({
                        id: `cm_${timestamp}_0`,
                        title: `${subject}概念圖`,
                        centralConcept: highlights[0] || subject,
                        relatedConcepts: highlights.slice(1, 4),
                        relationships: highlights.slice(1, 3).map(h => ({
                            from: highlights[0],
                            to: h,
                            relation: '相關'
                        })),
                        subject: subject,
                        created: new Date().toISOString()
                    });
                }
                
                // 生成練習題
                highlights.slice(0, 3).forEach((highlight, index) => {
                    materials.practiceQuestions.push({
                        id: `pq_${timestamp}_${index}`,
                        question: `下列哪個選項正確描述了${highlight}？`,
                        options: [
                            `A) ${highlight}是重要概念`,
                            `B) ${highlight}不重要`,
                            `C) ${highlight}很困難`,
                            `D) 以上都不對`
                        ],
                        correctAnswer: 'A',
                        explanation: `${highlight}確實是一個重要的概念，需要重點學習。`,
                        subject: subject,
                        difficulty: 'easy',
                        type: 'multiple-choice',
                        created: new Date().toISOString(),
                        attempts: 0,
                        correctAttempts: 0
                    });
                });
                
                return materials;
            };

            const deleteFile = (fileId) => {
                const fileToDelete = files.find(f => f.id === fileId);
                if (!fileToDelete) {
                    alert('找不到要刪除的檔案！');
                    return;
                }
                
                const confirmDelete = window.confirm(`確定要刪除檔案「${fileToDelete.name}」嗎？`);
                if (confirmDelete) {
                    setFiles(prevFiles => prevFiles.filter(f => f.id !== fileId));
                    alert(`檔案「${fileToDelete.name}」已成功刪除！`);
                }
            };

            const getItemsForReview = () => {
                const now = new Date();
                const allItems = [];
                
                flashcards.forEach(card => {
                    const nextReview = new Date(card.nextReview);
                    if (nextReview <= now && (selectedSubject === 'all' || card.subject === selectedSubject)) {
                        allItems.push({ ...card, type: 'flashcard' });
                    }
                });
                
                clozeCards.forEach(card => {
                    const nextReview = new Date(card.nextReview);
                    if (nextReview <= now && (selectedSubject === 'all' || card.subject === selectedSubject)) {
                        allItems.push({ ...card, type: 'cloze' });
                    }
                });

                conceptMaps.forEach(map => {
                    if (selectedSubject === 'all' || map.subject === selectedSubject) {
                        allItems.push({ ...map, type: 'conceptMap' });
                    }
                });

                practiceQuestions.forEach(question => {
                    if (selectedSubject === 'all' || question.subject === selectedSubject) {
                        allItems.push({ ...question, type: 'practiceQuestion' });
                    }
                });
                
                return allItems;
            };

            const startStudySession = () => {
                const items = getItemsForReview();
                if (items.length > 0) {
                    setCurrentItem(items[0]);
                    setShowAnswer(false);
                    setCurrentView('study');
                }
            };

            const nextItem = () => {
                const items = getItemsForReview();
                const currentIndex = items.findIndex(item => item.id === currentItem?.id);
                const nextIndex = (currentIndex + 1) % items.length;
                setCurrentItem(items[nextIndex]);
                setShowAnswer(false);
            };

            const updateSpacedRepetition = (cardId, quality) => {
                // 簡化的間隔重複邏輯
                setStudyProgress(prev => ({
                    ...prev,
                    [cardId]: {
                        ...prev[cardId],
                        lastReviewed: new Date().toISOString(),
                        totalReviews: (prev[cardId]?.totalReviews || 0) + 1,
                        quality: quality
                    }
                }));
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <nav className="bg-white shadow-sm border-b sticky top-0 z-50">
                        <div className="max-w-6xl mx-auto px-4 sm:px-6">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center space-x-2">
                                    <Brain />
                                    <span className="text-xl font-bold text-gray-900">AI Study Assistant</span>
                                </div>
                                <div className="flex space-x-4">
                                    {[
                                        { id: 'upload', label: 'Upload', icon: Upload },
                                        { id: 'subjects', label: 'Subjects', icon: BookOpen },
                                        { id: 'study', label: 'Study', icon: Brain },
                                        { id: 'progress', label: 'Progress', icon: BarChart3 }
                                    ].map(({ id, label, icon: Icon }) => (
                                        <button
                                            key={id}
                                            onClick={() => setCurrentView(id)}
                                            className={`flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${
                                                currentView === id 
                                                    ? 'bg-blue-100 text-blue-700' 
                                                    : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100'
                                            }`}
                                        >
                                            <Icon />
                                            <span className="text-sm font-medium">{label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="py-8">
                        {currentView === 'upload' && (
                            <div className="max-w-4xl mx-auto p-6">
                                <div className="bg-white rounded-lg shadow-lg p-8">
                                    <div className="text-center mb-8">
                                        <Brain />
                                        <h1 className="text-3xl font-bold text-gray-900 mb-2">AI Study Assistant</h1>
                                        <p className="text-gray-600">Upload your notes to generate learning materials</p>
                                        <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
                                            <p className="text-sm text-yellow-800">
                                                <strong>注意：</strong> 此版本使用基本材料生成功能。如需完整AI功能，請在Claude.ai中使用。
                                            </p>
                                        </div>
                                    </div>

                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
                                        <Upload />
                                        <label className="cursor-pointer">
                                            <span className="text-lg font-medium text-gray-900">Upload your files</span>
                                            <p className="text-gray-500 mt-2">Supports .md files</p>
                                            <input
                                                type="file"
                                                multiple
                                                accept=".md,.txt"
                                                onChange={handleFileUpload}
                                                className="hidden"
                                            />
                                            <div className="mt-4">
                                                <span className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                                                    Choose Files
                                                </span>
                                            </div>
                                        </label>
                                    </div>

                                    {isProcessing && (
                                        <div className="mt-6 text-center">
                                            <RefreshCw />
                                            <p className="text-gray-600">正在處理檔案...</p>
                                        </div>
                                    )}

                                    {files.length > 0 && (
                                        <div className="mt-8">
                                            <h3 className="text-lg font-semibold mb-4">已上傳檔案 ({files.length})</h3>
                                            <div className="space-y-3">
                                                {files.map(file => (
                                                    <div key={file.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                        <div className="flex items-center space-x-3">
                                                            <FileText />
                                                            <div>
                                                                <div className="font-medium text-gray-900">{file.name}</div>
                                                                <p className="text-sm text-gray-500">
                                                                    上傳時間: {new Date(file.uploadDate).toLocaleString()}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <button
                                                            onClick={() => deleteFile(file.id)}
                                                            className="text-red-500 hover:text-red-700 p-2 rounded-lg"
                                                        >
                                                            <Trash2 />
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {currentView === 'subjects' && (
                            <div className="max-w-4xl mx-auto p-6">
                                <div className="bg-white rounded-lg shadow-lg p-8">
                                    <h2 className="text-2xl font-bold mb-6">科目管理</h2>
                                    
                                    <div className="grid grid-cols-4 gap-6 mb-8">
                                        <div className="bg-blue-50 p-4 rounded-lg text-center">
                                            <h3 className="font-semibold text-blue-800">閃卡</h3>
                                            <p className="text-2xl font-bold text-blue-600">{flashcards.length}</p>
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-lg text-center">
                                            <h3 className="font-semibold text-green-800">克漏字卡</h3>
                                            <p className="text-2xl font-bold text-green-600">{clozeCards.length}</p>
                                        </div>
                                        <div className="bg-purple-50 p-4 rounded-lg text-center">
                                            <h3 className="font-semibold text-purple-800">概念圖</h3>
                                            <p className="text-2xl font-bold text-purple-600">{conceptMaps.length}</p>
                                        </div>
                                        <div className="bg-orange-50 p-4 rounded-lg text-center">
                                            <h3 className="font-semibold text-orange-800">練習題</h3>
                                            <p className="text-2xl font-bold text-orange-600">{practiceQuestions.length}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <h3 className="text-lg font-semibold">科目列表</h3>
                                        {subjects.length === 0 ? (
                                            <p className="text-gray-500 text-center py-8">尚未偵測到任何科目。請先上傳學習筆記。</p>
                                        ) : (
                                            subjects.map(subject => (
                                                <div key={subject.id} className="flex items-center justify-between p-4 border rounded-lg">
                                                    <div className="flex items-center space-x-4">
                                                        <BookOpen />
                                                        <div>
                                                            <div className="text-lg font-semibold">{subject.name}</div>
                                                            <p className="text-sm text-gray-500">{subject.fileCount} 檔案</p>
                                                        </div>
                                                    </div>
                                                    <span className="text-sm text-gray-500">
                                                        {subject.isManual ? '手動編輯' : '自動偵測'}
                                                    </span>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {currentView === 'study' && (
                            <div className="max-w-4xl mx-auto p-6">
                                <div className="bg-white rounded-lg shadow-lg p-8">
                                    <h2 className="text-2xl font-bold mb-6">學習模式</h2>
                                    
                                    <div className="mb-6">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">選擇科目</label>
                                        <select
                                            value={selectedSubject}
                                            onChange={(e) => setSelectedSubject(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="all">所有科目</option>
                                            {subjects.map(subject => (
                                                <option key={subject.id} value={subject.name}>
                                                    {subject.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {currentItem ? (
                                        <div className="text-center">
                                            <div className="flex justify-between mb-6">
                                                <div className="text-sm text-gray-500">
                                                    科目: {currentItem.subject} • 
                                                    類型: {
                                                        currentItem.type === 'flashcard' ? '閃卡' : 
                                                        currentItem.type === 'cloze' ? '克漏字卡' :
                                                        currentItem.type === 'conceptMap' ? '概念圖' :
                                                        currentItem.type === 'practiceQuestion' ? '練習題' : '未知'
                                                    }
                                                </div>
                                                <button
                                                    onClick={() => setCurrentItem(null)}
                                                    className="text-blue-500 hover:text-blue-700"
                                                >
                                                    退出學習模式
                                                </button>
                                            </div>

                                            <div className="bg-gray-50 rounded-lg p-6 mb-6 min-h-[200px] flex items-center justify-center">
                                                {currentItem.type === 'flashcard' ? (
                                                    <div className="w-full">
                                                        <p className="text-lg font-medium mb-4">{currentItem.front}</p>
                                                        {showAnswer && (
                                                            <div className="border-t pt-4">
                                                                <p className="text-gray-700">{currentItem.back}</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : currentItem.type === 'cloze' ? (
                                                    <div className="w-full">
                                                        <div className="text-lg font-medium mb-4">
                                                            {showAnswer ? 
                                                                currentItem.text.replace(/\{\{c\d+::(.*?)\}\}/g, '$1') :
                                                                currentItem.text.replace(/\{\{c\d+::(.*?)\}\}/g, '______')
                                                            }
                                                        </div>
                                                    </div>
                                                ) : currentItem.type === 'conceptMap' ? (
                                                    <div className="w-full">
                                                        <h3 className="text-xl font-bold mb-4">{currentItem.title}</h3>
                                                        <div className="text-center mb-4">
                                                            <div className="inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-lg font-semibold">
                                                                {currentItem.centralConcept}
                                                            </div>
                                                        </div>
                                                        {showAnswer && (
                                                            <div className="border-t pt-4">
                                                                <div className="grid grid-cols-3 gap-3 mb-4">
                                                                    {currentItem.relatedConcepts?.map((concept, index) => (
                                                                        <div key={index} className="bg-green-100 text-green-800 px-3 py-2 rounded text-center">
                                                                            {concept}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : currentItem.type === 'practiceQuestion' ? (
                                                    <div className="w-full">
                                                        <p className="text-lg font-medium mb-4">{currentItem.question}</p>
                                                        {currentItem.options && (
                                                            <div className="space-y-2 mb-4">
                                                                {currentItem.options.map((option, index) => (
                                                                    <div key={index} className="text-left bg-white p-3 rounded border">
                                                                        {option}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                        {showAnswer && (
                                                            <div className="border-t pt-4">
                                                                <p className="text-green-700 font-medium mb-2">正確答案: {currentItem.correctAnswer}</p>
                                                                {currentItem.explanation && (
                                                                    <p className="text-gray-700">{currentItem.explanation}</p>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : null}
                                            </div>

                                            <button
                                                onClick={() => setShowAnswer(!showAnswer)}
                                                className="bg-blue-500 text-white px-8 py-4 rounded-lg hover:bg-blue-600 mb-6"
                                            >
                                                {showAnswer ? '隱藏答案' : '顯示答案'}
                                            </button>

                                            {showAnswer && (
                                                <div className="flex justify-center space-x-4">
                                                    {(currentItem.type === 'flashcard' || currentItem.type === 'cloze') ? (
                                                        <>
                                                            <button
                                                                onClick={() => {
                                                                    updateSpacedRepetition(currentItem.id, 1);
                                                                    nextItem();
                                                                }}
                                                                className="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600"
                                                            >
                                                                困難 (1)
                                                            </button>
                                                            <button
                                                                onClick={() => {
                                                                    updateSpacedRepetition(currentItem.id, 3);
                                                                    nextItem();
                                                                }}
                                                                className="bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600"
                                                            >
                                                                普通 (3)
                                                            </button>
                                                            <button
                                                                onClick={() => {
                                                                    updateSpacedRepetition(currentItem.id, 5);
                                                                    nextItem();
                                                                }}
                                                                className="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600"
                                                            >
                                                                簡單 (5)
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <button
                                                            onClick={() => {
                                                                setStudyProgress(prev => ({
                                                                    ...prev,
                                                                    [currentItem.id]: {
                                                                        ...prev[currentItem.id],
                                                                        lastReviewed: new Date().toISOString(),
                                                                        totalReviews: (prev[currentItem.id]?.totalReviews || 0) + 1,
                                                                        type: currentItem.type
                                                                    }
                                                                }));
                                                                nextItem();
                                                            }}
                                                            className="bg-blue-500 text-white px-8 py-3 rounded-lg hover:bg-blue-600"
                                                        >
                                                            下一個項目
                                                        </button>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="text-center">
                                            <Calendar />
                                            <h3 className="text-xl font-semibold mb-2">準備好學習了嗎？</h3>
                                            <p className="text-gray-600 mb-6">
                                                你有 {getItemsForReview().length} 個項目可以學習
                                            </p>
                                            
                                            {getItemsForReview().length > 0 ? (
                                                <div className="space-y-4">
                                                    <div className="text-sm text-gray-500">
                                                        包含: {getItemsForReview().filter(item => item.type === 'flashcard').length} 張閃卡, 
                                                        {getItemsForReview().filter(item => item.type === 'cloze').length} 張克漏字卡,
                                                        {getItemsForReview().filter(item => item.type === 'conceptMap').length} 個概念圖,
                                                        {getItemsForReview().filter(item => item.type === 'practiceQuestion').length} 道練習題
                                                    </div>
                                                    <button
                                                        onClick={startStudySession}
                                                        className="bg-blue-500 text-white px-8 py-4 rounded-lg hover:bg-blue-600 text-lg font-semibold"
                                                    >
                                                        開始學習
                                                    </button>
                                                </div>
                                            ) : (
                                                <p className="text-gray-500">目前沒有學習項目。請先上傳檔案生成學習材料。</p>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {currentView === 'progress' && (
                            <div className="max-w-4xl mx-auto p-6">
                                <div className="bg-white rounded-lg shadow-lg p-8">
                                    <h2 className="text-2xl font-bold mb-6">學習進度</h2>
                                    
                                    <div className="grid grid-cols-5 gap-6 mb-8">
                                        <div className="bg-blue-50 p-4 rounded-lg text-center">
                                            <BarChart3 />
                                            <p className="text-2xl font-bold text-blue-600">{Object.keys(studyProgress).length}</p>
                                            <p className="text-sm text-blue-800">已學習項目</p>
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-lg text-center">
                                            <CheckCircle />
                                            <p className="text-2xl font-bold text-green-600">
                                                {Object.values(studyProgress).reduce((sum, item) => sum + (item.totalReviews || 0), 0)}
                                            </p>
                                            <p className="text-sm text-green-800">總複習次數</p>
                                        </div>
                                        <div className="bg-yellow-50 p-4 rounded-lg text-center">
                                            <Star />
                                            <p className="text-2xl font-bold text-yellow-600">{getItemsForReview().length}</p>
                                            <p className="text-sm text-yellow-800">可學習項目</p>
                                        </div>
                                        <div className="bg-purple-50 p-4 rounded-lg text-center">
                                            <Brain />
                                            <p className="text-2xl font-bold text-purple-600">{subjects.length}</p>
                                            <p className="text-sm text-purple-800">科目數量</p>
                                        </div>
                                        <div className="bg-orange-50 p-4 rounded-lg text-center">
                                            <BookOpen />
                                            <p className="text-2xl font-bold text-orange-600">
                                                {flashcards.length + clozeCards.length + conceptMaps.length + practiceQuestions.length}
                                            </p>
                                            <p className="text-sm text-orange-800">學習材料總數</p>
                                        </div>
                                    </div>

                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                        <h4 className="font-semibold text-blue-800 mb-3">💾 獨立版本說明</h4>
                                        <div className="text-sm text-blue-700 space-y-1">
                                            <p>✅ 此版本可離線使用，數據保存在瀏覽器中</p>
                                            <p>⚠️ AI功能有限，建議使用Claude.ai獲得完整體驗</p>
                                            <p>💡 支持基本的學習材料生成和複習功能</p>
                                        </div>
                                    </div>

                                    <h4 className="font-semibold text-gray-700 border-t pt-4 mb-4">最近學習記錄</h4>
                                    {Object.entries(studyProgress).length === 0 ? (
                                        <p className="text-center text-gray-500 py-8">尚無學習記錄，開始學習來查看進度吧！</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {Object.entries(studyProgress)
                                                .sort(([,a], [,b]) => new Date(b.lastReviewed) - new Date(a.lastReviewed))
                                                .slice(0, 10)
                                                .map(([cardId, progress]) => {
                                                    const card = [...flashcards, ...clozeCards, ...conceptMaps, ...practiceQuestions].find(c => c.id === cardId);
                                                    if (!card) return null;
                                                    
                                                    return (
                                                        <div key={cardId} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                            <div className="flex-1">
                                                                <p className="font-medium truncate">
                                                                    {card.type === 'flashcard' || card.front ? 
                                                                        (card.front || card.text).substring(0, 50) : 
                                                                        card.type === 'conceptMap' ?
                                                                        (card.title || card.centralConcept).substring(0, 50) :
                                                                        card.type === 'practiceQuestion' ?
                                                                        card.question.substring(0, 50) :
                                                                        card.text.replace(/\{\{c\d+::(.*?)\}\}/g, '$1').substring(0, 50)
                                                                    }...
                                                                </p>
                                                                <p className="text-sm text-gray-500">
                                                                    {card.subject} • {
                                                                        card.type === 'flashcard' || card.front ? '閃卡' : 
                                                                        card.type === 'conceptMap' ? '概念圖' :
                                                                        card.type === 'practiceQuestion' ? '練習題' :
                                                                        '克漏字卡'
                                                                    }
                                                                </p>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className="text-sm font-medium">
                                                                    {progress.quality ? `品質: ${progress.quality}/5` : '已學習'}
                                                                </p>
                                                                <p className="text-xs text-gray-500">
                                                                    {new Date(progress.lastReviewed).toLocaleDateString()}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<AIStudyApp />, document.getElementById('root'));
    </script>
</body>
</html>